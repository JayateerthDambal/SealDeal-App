rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow users to read and write their own deals
    match /deals/{dealId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.ownerId;

      // Allow users to access sub-collections of deals they own
      match /{allPaths=**} {
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/deals/$(dealId)).data.ownerId == request.auth.uid;
      }
    }

    // NEW & IMPORTANT RULE: Allow querying the 'analysis' collection group
    // This allows the dashboard to gather all analysis data for the logged-in user.
    match /{path=**}/analysis/{analysisId} {
      allow get, list: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }

    // Rules for benchmarks (adjust as needed)
    match /benchmarks/{benchmarkId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null; // In production, you'd restrict this to admins
    }

    // Rules for chat sessions
    match /chat_sessions/{sessionId}/{allPaths=**} {
      allow read, write: if request.auth != null; // Secure this further in production if needed
    }
  }
}
